{% extends "base.html" %}
{% block content %}

<h1>{{ idea.title }}</h1>

{% if idea.image %}
<img src="{{ idea.image.url }}" width="300">
{% endif %}

<p>{{ idea.content }}</p>
<p>관심도: <span id="interest-{{ idea.pk }}">{{ idea.interest }}</span></p>

<p>
    개발툴:
    <a href="{% url 'devtools:detail' idea.devtool.pk %}">
        {{ idea.devtool.name }}
    </a>
</p>

<!-- 별 -->
<button class="star-btn" data-id="{{ idea.pk }}">
    {% if star.is_starred %}★{% else %}☆{% endif %}
</button>

<!-- interest -->
<div>
    <button class="interest-btn" data-id="{{ idea.pk }}" data-delta="-1">-</button>
    <button class="interest-btn" data-id="{{ idea.pk }}" data-delta="1">+</button>
</div>

<hr>

<a href="{% url 'ideas:update' idea.pk %}">수정</a>

<form action="{% url 'ideas:delete' idea.pk %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit">삭제</button>
</form>

<a href="{% url 'home' %}">목록</a>

<!-- AJAX -->
<script>
    document.addEventListener("click", async (e) => {

        if (e.target.classList.contains("star-btn")) {
            const id = e.target.dataset.id;

            const res = await fetch(`/ideas/${id}/toggle-star/`, {
                method: "POST",
                headers: { "X-CSRFToken": csrftoken }
            });

            const data = await res.json();
            e.target.textContent = data.starred ? "★" : "☆";
        }

        if (e.target.classList.contains("interest-btn")) {
            const id = e.target.dataset.id;
            const delta = e.target.dataset.delta;

            const body = new URLSearchParams();
            body.append("delta", delta);

            const res = await fetch(`/ideas/${id}/interest/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrftoken,
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: body.toString(),
            });

            const data = await res.json();
            document.querySelector(`#interest-${id}`).textContent = data.interest;
        }

    });
</script>

{% endblock %}